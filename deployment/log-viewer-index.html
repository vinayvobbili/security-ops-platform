<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IR Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1600px;
            width: 100%;
            padding: 40px 50px;
        }

        h1 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.9em;
        }

        .subtitle {
            color: #718096;
            margin-bottom: 16px;
            font-size: 1.05em;
        }

        /* Status Bar */
        .status-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .status-bar:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .status-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            font-size: 1.5em;
        }

        .status-text {
            font-size: 1.1em;
            font-weight: 500;
        }

        .status-count {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .expand-icon {
            transition: transform 0.3s ease;
        }

        .status-bar.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .status-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .status-bar.expanded .status-details {
            max-height: 600px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bot-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .bot-status-item:last-child {
            border-bottom: none;
        }

        .bot-status-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bot-status-controls {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Log Grid */
        .log-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }

        .log-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 24px;
            padding-bottom: 140px;
            text-decoration: none;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            min-height: 220px;
            display: flex;
            flex-direction: column;
        }

        .log-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        .log-card.featured {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding-bottom: 24px;
            min-height: auto;
        }

        .log-card.status-down {
            background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .log-card h3 {
            font-size: 1.3em;
            margin: 0;
        }

        .card-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            opacity: 0.95;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-dot.running {
            background: #48bb78;
        }

        .status-dot.stopped {
            background: #f56565;
            animation: none;
        }

        .status-dot.error {
            background: #ed8936;
            animation: blink 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes blink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }

        .log-card p {
            opacity: 0.9;
            font-size: 0.9em;
            margin: 0;
        }

        /* Card Overlay */
        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(10px);
            padding: 14px 20px;
            opacity: 1;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-overlay-content {
            font-size: 0.82em;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .card-overlay-content div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-card {
            flex: 1;
            min-width: 75px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 7px 11px;
            border-radius: 6px;
            font-size: 0.78em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .btn-card:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-1px);
        }

        .btn-card:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-card.btn-start {
            background: rgba(72, 187, 120, 0.3);
            border-color: rgba(72, 187, 120, 0.5);
        }

        .btn-card.btn-start:hover {
            background: rgba(72, 187, 120, 0.5);
        }

        .btn-card.btn-stop {
            background: rgba(245, 101, 101, 0.3);
            border-color: rgba(245, 101, 101, 0.5);
        }

        .btn-card.btn-stop:hover {
            background: rgba(245, 101, 101, 0.5);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            max-width: 350px;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #f56565;
        }

        .toast.info {
            border-left: 4px solid #4299e1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #2d3748;
        }

        .toast-message {
            font-size: 0.9em;
            color: #4a5568;
        }

        /* Features */
        .features {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px 30px;
            margin-top: 20px;
        }

        .features h3 {
            color: #2d3748;
            margin-bottom: 12px;
        }

        .features ul {
            list-style: none;
            color: #4a5568;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px 20px;
        }

        .features li {
            padding: 6px 0;
            padding-left: 24px;
            position: relative;
        }

        .features li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #48bb78;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            margin-top: 16px;
            color: #a0aec0;
            font-size: 0.9em;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üîç IR Log Viewer</h1>
    <p class="subtitle">Real-time log monitoring for all IR services</p>

    <!-- Status Bar -->
    <div class="status-bar" id="statusBar" onclick="toggleStatusDetails()">
        <div class="status-summary">
            <div class="status-left">
                <span class="status-indicator" id="statusIndicator">‚è≥</span>
                <div>
                    <div class="status-text" id="statusText">Loading...</div>
                    <div class="status-count" id="statusCount">Checking bot status...</div>
                </div>
            </div>
            <div class="status-right">
                <span id="lastUpdate">Just now</span>
                <span class="expand-icon">‚ñº</span>
            </div>
        </div>
        <div class="status-details" id="statusDetails">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Log Cards Grid -->
    <div class="log-grid" id="logGrid">
        <a href="http://localhost:8031" class="log-card featured" target="_blank">
            <div class="card-header">
                <h3>üìä All Services</h3>
            </div>
            <p>Combined view of all IR services using journalctl</p>
        </a>

        <!-- Bot cards will be populated by JavaScript -->
    </div>

    <div class="features">
        <h3>Features</h3>
        <ul>
            <li>Real-time bot status monitoring</li>
            <li>Start/Stop/Restart bots from the web interface</li>
            <li>Live log streaming with color-coded levels</li>
            <li>Full-text search across logs (Ctrl+F)</li>
            <li>Resource usage monitoring (CPU, Memory, Uptime)</li>
            <li>Auto-refresh every 10 seconds</li>
            <li>No SSH access required</li>
        </ul>
    </div>

    <div class="footer">
        Security Operations Team
    </div>
</div>

<!-- Toast Container -->
<div class="toast" id="toast">
    <div class="toast-title" id="toastTitle"></div>
    <div class="toast-message" id="toastMessage"></div>
</div>

<script>
    const API_BASE = 'http://localhost:8040/api';
    const API_AUTH = btoa('admin:admin'); // Basic auth

    let lastStatusData = null;
    let refreshInterval = null;

    // Bot configuration
    const BOTS = [
        { key: 'toodles', name: 'Toodles', emoji: 'üéØ', port: 8032 },
        { key: 'msoar', name: 'MSOAR', emoji: 'ü§ñ', port: 8033 },
        { key: 'moneyball', name: 'MoneyBall', emoji: 'üí∞', port: 8034 },
        { key: 'jarvis', name: 'Jarvis', emoji: 'üõ°Ô∏è', port: 8035 },
        { key: 'barnacles', name: 'Barnacles', emoji: '‚öì', port: 8036 },
        { key: 'tars', name: 'TARS', emoji: 'ü§ñ', port: 8038 },
        { key: 'jobs', name: 'All Jobs', emoji: '‚è∞', port: 8037 },
        { key: 'webserver', name: 'Web Server', emoji: 'üåê', port: 8039 }
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        initializeBotCards();
        fetchStatus();
        startAutoRefresh();
    });

    function initializeBotCards() {
        const logGrid = document.getElementById('logGrid');
        const featuredCard = logGrid.querySelector('.featured');

        BOTS.forEach(bot => {
            const card = createBotCard(bot);
            logGrid.appendChild(card);
        });
    }

    function createBotCard(bot) {
        const card = document.createElement('div');
        card.className = 'log-card';
        card.id = `card-${bot.key}`;
        card.innerHTML = `
            <div class="card-header">
                <h3>${bot.emoji} ${bot.name}</h3>
                <div class="card-status">
                    <span class="status-dot stopped" id="dot-${bot.key}"></span>
                    <span id="status-${bot.key}">Checking...</span>
                </div>
            </div>
            <p id="desc-${bot.key}">${bot.name} bot logs</p>
            <div class="card-overlay" id="overlay-${bot.key}">
                <div class="card-overlay-content" id="info-${bot.key}">
                    <div><span>Status:</span><span>Checking...</span></div>
                </div>
                <div class="card-actions">
                    <button class="btn-card" onclick="window.open('http://localhost:${bot.port}', '_blank')">View Logs</button>
                    <button class="btn-card btn-start" id="start-${bot.key}" onclick="controlBot('${bot.key}', 'start')" disabled>Start</button>
                    <button class="btn-card" id="restart-${bot.key}" onclick="controlBot('${bot.key}', 'restart')" disabled>Restart</button>
                    <button class="btn-card btn-stop" id="stop-${bot.key}" onclick="controlBot('${bot.key}', 'stop')" disabled>Stop</button>
                </div>
            </div>
        `;
        return card;
    }

    async function fetchStatus() {
        try {
            const response = await fetch(`${API_BASE}/status`, {
                headers: {
                    'Authorization': `Basic ${API_AUTH}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch status');
            }

            const data = await response.json();
            lastStatusData = data;
            updateUI(data);
            updateLastUpdateTime();

        } catch (error) {
            console.error('Error fetching status:', error);
            showToast('Error', 'Failed to fetch bot status', 'error');
        }
    }

    function updateUI(data) {
        updateStatusBar(data);
        updateBotCards(data);
    }

    function updateStatusBar(data) {
        const { summary, bots } = data;
        const running = summary.running;
        const total = summary.total;

        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const statusCount = document.getElementById('statusCount');

        if (running === total) {
            statusIndicator.textContent = '‚úÖ';
            statusText.textContent = 'All Systems Operational';
        } else if (running === 0) {
            statusIndicator.textContent = '‚ùå';
            statusText.textContent = 'All Systems Down';
        } else {
            statusIndicator.textContent = '‚ö†Ô∏è';
            statusText.textContent = 'Partial Systems Online';
        }

        statusCount.textContent = `${running} of ${total} bots running`;

        // Update details panel
        const statusDetails = document.getElementById('statusDetails');
        statusDetails.innerHTML = Object.values(bots).map(bot => `
            <div class="bot-status-item">
                <div class="bot-status-name">
                    <span>${bot.emoji} ${bot.name}</span>
                    <span class="status-dot ${bot.status}" style="width: 8px; height: 8px;"></span>
                    <span style="font-size: 0.85em; opacity: 0.9;">${bot.status}</span>
                </div>
                <div class="bot-status-controls">
                    ${bot.status === 'running'
                        ? `<button class="btn-small" onclick="controlBot('${bot.key}', 'restart')">Restart</button>
                           <button class="btn-small" onclick="controlBot('${bot.key}', 'stop')">Stop</button>`
                        : `<button class="btn-small" onclick="controlBot('${bot.key}', 'start')">Start</button>`
                    }
                </div>
            </div>
        `).join('');
    }

    function formatUptime(uptime) {
        if (!uptime) return 'N/A';

        // Format: "20-06:12:53" = 20 days, 6 hours, 12 minutes, 53 seconds
        // or "06:12:53" = 6 hours, 12 minutes, 53 seconds
        // or "12:53" = 12 minutes, 53 seconds

        const parts = uptime.split('-');
        let days = 0;
        let timeStr = uptime;

        if (parts.length === 2) {
            days = parseInt(parts[0]);
            timeStr = parts[1];
        }

        const timeParts = timeStr.split(':');

        if (days > 0) {
            const hours = parseInt(timeParts[0]);
            return `${days}d ${hours}h`;
        } else if (timeParts.length === 3) {
            const hours = parseInt(timeParts[0]);
            const minutes = parseInt(timeParts[1]);
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        } else {
            const minutes = parseInt(timeParts[0]);
            return `${minutes}m`;
        }
    }

    function updateBotCards(data) {
        const { bots } = data;

        Object.values(bots).forEach(bot => {
            const card = document.getElementById(`card-${bot.key}`);
            const dot = document.getElementById(`dot-${bot.key}`);
            const status = document.getElementById(`status-${bot.key}`);
            const desc = document.getElementById(`desc-${bot.key}`);
            const info = document.getElementById(`info-${bot.key}`);
            const startBtn = document.getElementById(`start-${bot.key}`);
            const restartBtn = document.getElementById(`restart-${bot.key}`);
            const stopBtn = document.getElementById(`stop-${bot.key}`);

            // Update status dot
            dot.className = `status-dot ${bot.status}`;

            // Update status text
            if (bot.status === 'running') {
                status.textContent = 'Live';
                desc.textContent = `Running ‚Ä¢ PID ${bot.pid}`;
                card.classList.remove('status-down');

                // Update info overlay
                info.innerHTML = `
                    <div><span>Uptime:</span><span>${formatUptime(bot.uptime)}</span></div>
                    <div><span>Memory:</span><span>${bot.memory_mb}MB (${bot.memory_percent.toFixed(1)}%)</span></div>
                    <div><span>CPU:</span><span>${bot.cpu_percent.toFixed(1)}%</span></div>
                `;

                // Enable/disable buttons
                startBtn.disabled = true;
                restartBtn.disabled = false;
                stopBtn.disabled = false;

            } else if (bot.status === 'stopped') {
                status.textContent = 'Down';
                desc.textContent = 'Not running';
                card.classList.add('status-down');

                info.innerHTML = `<div><span>Status:</span><span>Stopped</span></div>`;

                startBtn.disabled = false;
                restartBtn.disabled = true;
                stopBtn.disabled = true;

            } else {
                status.textContent = 'Error';
                desc.textContent = 'Status unknown';

                info.innerHTML = `<div><span>Status:</span><span>Error</span></div>`;

                startBtn.disabled = false;
                restartBtn.disabled = false;
                stopBtn.disabled = false;
            }
        });
    }

    async function controlBot(botKey, action) {
        const actionText = action.charAt(0).toUpperCase() + action.slice(1);

        // Disable all buttons for this bot
        ['start', 'restart', 'stop'].forEach(a => {
            const btn = document.getElementById(`${a}-${botKey}`);
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span>';
            }
        });

        try {
            const response = await fetch(`${API_BASE}/control/${botKey}/${action}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Basic ${API_AUTH}`
                }
            });

            const data = await response.json();

            if (data.success) {
                showToast('Success', data.message, 'success');
                // Refresh status after 2 seconds to allow bot to start/stop
                setTimeout(fetchStatus, 2000);
            } else {
                showToast('Error', data.message || `Failed to ${action} bot`, 'error');
                // Re-enable buttons
                fetchStatus();
            }

        } catch (error) {
            console.error(`Error ${action}ing bot:`, error);
            showToast('Error', `Failed to ${action} bot`, 'error');
            // Re-enable buttons
            fetchStatus();
        }
    }

    function toggleStatusDetails() {
        const statusBar = document.getElementById('statusBar');
        statusBar.classList.toggle('expanded');
    }

    function updateLastUpdateTime() {
        const lastUpdate = document.getElementById('lastUpdate');
        lastUpdate.textContent = 'Just now';
    }

    function startAutoRefresh() {
        refreshInterval = setInterval(() => {
            fetchStatus();
        }, 10000); // Refresh every 10 seconds
    }

    function showToast(title, message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastTitle = document.getElementById('toastTitle');
        const toastMessage = document.getElementById('toastMessage');

        toastTitle.textContent = title;
        toastMessage.textContent = message;

        toast.className = `toast ${type} show`;

        setTimeout(() => {
            toast.classList.remove('show');
        }, 4000);
    }

    // Update "last updated" text every second
    setInterval(() => {
        if (lastStatusData) {
            const lastUpdate = document.getElementById('lastUpdate');
            const now = new Date();
            const timestamp = new Date(lastStatusData.timestamp);
            const seconds = Math.floor((now - timestamp) / 1000);

            if (seconds < 60) {
                lastUpdate.textContent = `${seconds}s ago`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                lastUpdate.textContent = `${minutes}m ago`;
            } else {
                const hours = Math.floor(seconds / 3600);
                lastUpdate.textContent = `${hours}h ago`;
            }
        }
    }, 1000);
</script>
</body>
</html>
