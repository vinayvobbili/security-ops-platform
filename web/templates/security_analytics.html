<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/metrics-dashboard-icon.ico') }}" type="image/x-icon">

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, rgba(0, 70, 173, 0.9) 0%, rgba(74, 139, 194, 0.9) 30%, rgba(0, 166, 81, 0.9) 70%, rgba(102, 204, 153, 0.9) 100%);
            --container-bg: rgba(255, 255, 255, 0.95);
            --filter-bg: rgba(0, 70, 173, 0.1);
            --filter-border: rgba(0, 166, 81, 0.3);
            --text-primary: #0046ad;
            --text-secondary: #495057;
            --card-bg: white;
            --checkbox-bg: white;
            --hover-bg: rgba(0, 70, 173, 0.1);
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 30%, rgba(51, 65, 85, 0.95) 70%, rgba(71, 85, 105, 0.95) 100%);
            --container-bg: rgba(30, 41, 59, 0.95);
            --filter-bg: rgba(51, 65, 85, 0.3);
            --filter-border: rgba(71, 85, 105, 0.5);
            --text-primary: #60a5fa;
            --text-secondary: #e2e8f0;
            --card-bg: rgba(51, 65, 85, 0.8);
            --checkbox-bg: rgba(71, 85, 105, 0.6);
            --hover-bg: rgba(51, 65, 85, 0.4);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            padding-top: 80px;
            background: var(--bg-gradient);
            min-height: 100vh;
            backdrop-filter: blur(10px);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .dashboard-container {
            max-width: 2100px;
            min-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 70, 173, 0.3), 0 5px 15px rgba(0, 166, 81, 0.2);
            margin-top: 20px;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            overflow-x: auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f2f5;
        }

        .dashboard-title {
            font-size: 2.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .audio-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .music-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            filter: invert(1);
        }

        .filters-section {
            background: var(--filter-bg);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--filter-border);
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .filters-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2E86AB;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 2fr 1fr;
            gap: 12px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .filter-select, .filter-input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .filter-select[multiple] {
            padding: 4px;
            height: auto;
            min-height: 100px;
        }

        .filter-select[multiple] option {
            padding: 4px 8px;
            margin: 1px 0;
            border-radius: 3px;
        }

        .filter-select[multiple] option:checked {
            background: linear-gradient(135deg, rgba(0, 70, 173, 0.8), rgba(0, 166, 81, 0.8));
            color: white;
        }

        .checkbox-filter {
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 8px;
            background: white;
            max-height: 120px;
            overflow-y: auto;
        }

        .checkbox-filter label {
            display: block;
            padding: 4px 0;
            cursor: pointer;
            font-size: 14px;
            margin: 0;
        }

        .checkbox-filter label:hover {
            background: rgba(0, 70, 173, 0.1);
            border-radius: 3px;
        }

        .checkbox-filter input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 0;
        }

        .radio-group label:hover {
            background: rgba(0, 70, 173, 0.1);
            border-radius: 3px;
        }

        .radio-group input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .filter-summary {
            background: rgba(0, 70, 173, 0.1);
            border: 2px solid rgba(0, 166, 81, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
        }

        .filter-summary strong {
            color: #0046ad;
        }

        #filterText {
            color: var(--text-secondary);
        }

        .theme-toggle {
            position: fixed;
            top: 12px;
            right: 70px;
            z-index: 2000;
            background: var(--container-bg);
            border: 2px solid var(--filter-border);
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 4px 15px rgba(0, 70, 173, 0.4);
        }

        .ticket-type-filter .checkbox-filter {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            column-gap: 12px;
        }

        #countryFilter {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            column-gap: 8px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            min-width: 0;
            overflow: hidden;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-canvas {
            height: 400px;
            width: 100%;
        }

        .data-table-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .severity-critical { color: #dc3545; font-weight: bold; }
        .severity-high { color: #fd7e14; font-weight: bold; }
        .severity-medium { color: #ffc107; font-weight: bold; }
        .severity-low { color: #28a745; }
        .severity-unknown { color: #6c757d; }

        .status-active { color: #007bff; font-weight: bold; }
        .status-closed { color: #28a745; }
        .status-pending { color: #ffc107; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .export-section {
            margin-top: 20px;
            text-align: center;
        }

        .export-btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s ease;
        }

        .export-btn:hover {
            background: #0056b3;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #007bff;
            color: #007bff;
            padding: 10px 15px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-btn:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <div class="top-nav">
        <div class="nav-burger" onclick="toggleMenu()">
            <img src="{{ url_for('static', filename='icons/burger.svg') }}" alt="Menu" class="nav-icon">
        </div>
        <div id="burgerMenu" class="burger-menu-content" style="display:none;">
            <a href="/">Home Dashboard</a>
            <a href="/xsoar">XSOAR Dashboard</a>
            <a href="/security-analytics">üõ°Ô∏è Security Analytics</a>
            <a href="/msoc-form">MSOC Form</a>
            <a href="/speak-up-form">Speak Up Form</a>
            <a href="/travel-form">Travel Form</a>
            <a href="/red-team-testing-form">Red Team Testing</a>
            <a href="/xsoar-ticket-import-form">XSOAR Ticket Import</a>
            <a href="/apt-other-names-search">APT Other Names Search</a>
        </div>
    </div>

    <audio id="music" src="" loop muted></audio>
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
        üåô
    </div>
    <div class="audio-controls">
        <button onclick="toggleAudio()">
            <img src="/static/icons/volume-xmark-solid.svg" alt="Unmute Icon" class="music-icon" id="music-icon">
        </button>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Security Incident Analytics</h1>
            <p class="dashboard-subtitle">Real-time analytics and insights from XSOAR security incidents</p>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="filters-header">
                üéõÔ∏è Filter Controls
            </div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">üìÖ Date Range</label>
                    <div class="radio-group">
                        <label><input type="radio" name="dateRange" value="7"> Last 7 days</label>
                        <label><input type="radio" name="dateRange" value="30" checked> Last 30 days</label>
                        <label><input type="radio" name="dateRange" value="60"> Last 60 days</label>
                        <label><input type="radio" name="dateRange" value="90"> Last 90 days</label>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üåç Country</label>
                    <div id="countryFilter" class="checkbox-filter">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üí• Impact Level</label>
                    <div id="impactFilter" class="checkbox-filter">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üö® Severity</label>
                    <div id="severityFilter" class="checkbox-filter">
                        <label><input type="checkbox" value="4"> Critical</label>
                        <label><input type="checkbox" value="3"> High</label>
                        <label><input type="checkbox" value="2"> Medium</label>
                        <label><input type="checkbox" value="1"> Low</label>
                    </div>
                </div>
                <div class="filter-group ticket-type-filter">
                    <label class="filter-label">üé´ Ticket Type</label>
                    <div id="ticketTypeFilter" class="checkbox-filter">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">üìä Status</label>
                    <div id="statusFilter" class="checkbox-filter">
                        <label><input type="checkbox" value="0"> Pending</label>
                        <label><input type="checkbox" value="1"> Active</label>
                        <label><input type="checkbox" value="2"> Closed</label>
                    </div>
                </div>
            </div>

            <!-- Filter Summary -->
            <div class="filter-summary" id="filterSummary">
                <strong>Active Filters:</strong> <span id="filterText">Last 30 days</span>
            </div>
        </div>

        <!-- Loading/Error Display -->
        <div id="loading" class="loading">
            üîÑ Loading security incident data...
        </div>
        <div id="error" class="error" style="display: none;"></div>

        <!-- Metrics Cards -->
        <div id="metricsGrid" class="metrics-grid" style="display: none;">
            <!-- Metrics will be populated by JavaScript -->
        </div>

        <!-- Charts Grid -->
        <div id="chartsGrid" class="charts-grid" style="display: none;">
            <div class="chart-container">
                <div class="chart-title">üåç Geographic Distribution</div>
                <div id="geoChart" class="chart-canvas"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üö® Severity Distribution</div>
                <div id="severityChart" class="chart-canvas"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üìà Daily Incident Timeline</div>
                <div id="timelineChart" class="chart-canvas"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üé´ Ticket Types</div>
                <div id="ticketTypeChart" class="chart-canvas"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üí• Impact vs Status Heatmap</div>
                <div id="heatmapChart" class="chart-canvas"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">üîÑ Incident Status Funnel</div>
                <div id="funnelChart" class="chart-canvas"></div>
            </div>
        </div>

        <!-- Data Table -->
        <div id="dataTableSection" class="data-table-section" style="display: none;">
            <div class="table-header">üìã Incident Details</div>
            <div style="overflow-x: auto;">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Severity</th>
                            <th>Status</th>
                            <th>Country</th>
                            <th>Impact</th>
                            <th>Source</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="export-section">
                <button class="export-btn" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="export-btn" onclick="exportSummary()">üìä Export Summary</button>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];

        // Color schemes for consistent theming
        const colorSchemes = {
            severity: ['#6c757d', '#28a745', '#ffc107', '#fd7e14', '#dc3545'],
            status: ['#ffc107', '#007bff', '#28a745', '#6c757d'],
            countries: ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'],
            sources: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FECA57', '#FF9FF3', '#54A0FF', '#5F27CD']
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Add listeners for date range radio buttons
            document.querySelectorAll('input[name="dateRange"]').forEach(radio => {
                radio.addEventListener('change', applyFilters);
            });

            // Add listeners for existing severity and status checkboxes
            document.querySelectorAll('#severityFilter input, #statusFilter input').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }

        async function loadData() {
            try {
                const response = await fetch('/api/security-analytics/data');
                const result = await response.json();

                if (result.success) {
                    allData = result.data;
                    populateFilterOptions();
                    applyFilters();
                    hideLoading();
                } else {
                    showError('Failed to load data: ' + result.error);
                }
            } catch (error) {
                showError('Error loading data: ' + error.message);
            }
        }

        function populateFilterOptions() {
            // Populate filters with checkboxes
            const countries = [...new Set(allData.map(item => item.affected_country))].filter(c => c && c !== 'Unknown').sort();
            const impacts = [...new Set(allData.map(item => item.impact))].filter(i => i && i !== 'Unknown').sort();
            const ticketTypes = [...new Set(allData.map(item => item.type))].filter(t => t && t !== 'Unknown').sort();

            populateCheckboxFilter('countryFilter', countries);
            populateCheckboxFilter('impactFilter', impacts);
            populateCheckboxFilter('ticketTypeFilter', ticketTypes);
        }

        function populateCheckboxFilter(filterId, options) {
            const container = document.getElementById(filterId);
            options.forEach(option => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = option;
                checkbox.addEventListener('change', applyFilters);

                // For ticket types, remove METCIRT prefix for display
                let displayText = option;
                if (filterId === 'ticketTypeFilter' && option.startsWith('METCIRT')) {
                    displayText = option.replace(/^METCIRT[_\-\s]*/i, '');
                }

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' ' + displayText));
                container.appendChild(label);
            });
        }

        function applyFilters() {
            const dateRange = parseInt(document.querySelector('input[name="dateRange"]:checked').value);
            const countries = Array.from(document.querySelectorAll('#countryFilter input:checked')).map(cb => cb.value);
            const impacts = Array.from(document.querySelectorAll('#impactFilter input:checked')).map(cb => cb.value);
            const severities = Array.from(document.querySelectorAll('#severityFilter input:checked')).map(cb => cb.value);
            const ticketTypes = Array.from(document.querySelectorAll('#ticketTypeFilter input:checked')).map(cb => cb.value);
            const statuses = Array.from(document.querySelectorAll('#statusFilter input:checked')).map(cb => cb.value);

            // Update filter summary
            updateFilterSummary(dateRange, countries, impacts, severities, ticketTypes, statuses);

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - dateRange);

            filteredData = allData.filter(item => {
                // Date filter
                const createdDate = new Date(item.created);
                if (createdDate < cutoffDate) return false;

                // Other filters
                if (countries.length > 0 && !countries.includes(item.affected_country)) return false;
                if (impacts.length > 0 && !impacts.includes(item.impact)) return false;
                if (severities.length > 0 && !severities.includes(item.severity.toString())) return false;
                if (ticketTypes.length > 0 && !ticketTypes.includes(item.type)) return false;
                if (statuses.length > 0 && !statuses.includes(item.status.toString())) return false;

                return true;
            });

            updateDashboard();
        }

        function updateFilterSummary(dateRange, countries, impacts, severities, ticketTypes, statuses) {
            const filterParts = [];

            // Date range
            const dateText = dateRange === 7 ? 'Last 7 days' :
                           dateRange === 30 ? 'Last 30 days' :
                           dateRange === 60 ? 'Last 60 days' :
                           dateRange === 90 ? 'Last 90 days' :
                           dateRange === 365 ? 'Last year' : `Last ${dateRange} days`;
            filterParts.push(dateText);

            // Add other filters if selected
            if (countries.length > 0) {
                filterParts.push(`Countries: ${countries.join(', ')}`);
            }
            if (impacts.length > 0) {
                filterParts.push(`Impact: ${impacts.join(', ')}`);
            }
            if (severities.length > 0) {
                const severityNames = severities.map(s =>
                    s === '4' ? 'Critical' : s === '3' ? 'High' : s === '2' ? 'Medium' : s === '1' ? 'Low' : 'Unknown'
                );
                filterParts.push(`Severity: ${severityNames.join(', ')}`);
            }
            if (ticketTypes.length > 0) {
                const displayTypes = ticketTypes.map(type =>
                    type.startsWith('METCIRT') ? type.replace(/^METCIRT[_\-\s]*/i, '') : type
                );
                filterParts.push(`Types: ${displayTypes.join(', ')}`);
            }
            if (statuses.length > 0) {
                const statusNames = statuses.map(s =>
                    s === '0' ? 'Pending' : s === '1' ? 'Active' : s === '2' ? 'Closed' : 'Unknown'
                );
                filterParts.push(`Status: ${statusNames.join(', ')}`);
            }

            document.getElementById('filterText').textContent = filterParts.join(' | ');
        }

        function updateDashboard() {
            updateMetrics();
            updateCharts();
            updateTable();
            showDashboard();
        }

        function updateMetrics() {
            const totalIncidents = filteredData.length;
            const criticalIncidents = filteredData.filter(item => item.severity === 4).length;
            const openIncidents = filteredData.filter(item => item.status !== 2).length;
            const containedIncidents = filteredData.filter(item => item.contained === true).length;

            const metricsHTML = `
                <div class="metric-card">
                    <div class="metric-title">üé´ Total Incidents</div>
                    <div class="metric-value">${totalIncidents.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üö® Critical</div>
                    <div class="metric-value">${criticalIncidents.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üìà Open</div>
                    <div class="metric-value">${openIncidents.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üîí Contained</div>
                    <div class="metric-value">${containedIncidents.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üåç Countries</div>
                    <div class="metric-value">${new Set(filteredData.map(item => item.affected_country)).size}</div>
                </div>
            `;

            document.getElementById('metricsGrid').innerHTML = metricsHTML;
        }

        function updateCharts() {
            createGeoChart();
            createSeverityChart();
            createTimelineChart();
            createTicketTypeChart();
            createHeatmapChart();
            createFunnelChart();
        }

        function createGeoChart() {
            const counts = {};
            filteredData.forEach(item => {
                const country = item.affected_country || 'Unknown';
                counts[country] = (counts[country] || 0) + 1;
            });

            const sortedEntries = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            const trace = {
                x: sortedEntries.map(([country, count]) => count),
                y: sortedEntries.map(([country, count]) => country),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: colorSchemes.countries,
                    line: { color: 'rgba(255,255,255,0.8)', width: 1 }
                },
                hovertemplate: '<b>%{y}</b><br>Incidents: %{x}<extra></extra>'
            };

            const layout = {
                margin: { l: 120, r: 20, t: 40, b: 40 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { gridcolor: 'rgba(128,128,128,0.2)' },
                yaxis: { gridcolor: 'rgba(128,128,128,0.2)' }
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('geoChart', [trace], layout, config);
        }

        function createSeverityChart() {
            const severityMap = { 0: 'Unknown', 1: 'Low', 2: 'Medium', 3: 'High', 4: 'Critical' };
            const counts = { 'Unknown': 0, 'Low': 0, 'Medium': 0, 'High': 0, 'Critical': 0 };

            filteredData.forEach(item => {
                const severity = severityMap[item.severity] || 'Unknown';
                counts[severity]++;
            });

            const trace = {
                labels: Object.keys(counts),
                values: Object.values(counts),
                type: 'pie',
                hole: 0.4,
                marker: {
                    colors: colorSchemes.severity,
                    line: { color: 'white', width: 2 }
                },
                textinfo: 'label+percent+value',
                textfont: { size: 12 },
                hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
            };

            const layout = {
                margin: { l: 20, r: 20, t: 40, b: 40 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.1 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('severityChart', [trace], layout, config);
        }

        function createTimelineChart() {
            const dailyCounts = {};
            filteredData.forEach(item => {
                const date = new Date(item.created).toISOString().split('T')[0];
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });

            const sortedDates = Object.keys(dailyCounts).sort();

            const trace = {
                x: sortedDates,
                y: sortedDates.map(date => dailyCounts[date]),
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#007bff', width: 3 },
                marker: { color: '#007bff', size: 6 },
                fill: 'tonexty',
                fillcolor: 'rgba(0, 123, 255, 0.1)',
                hovertemplate: '<b>%{x}</b><br>Incidents: %{y}<extra></extra>'
            };

            const layout = {
                margin: { l: 60, r: 20, t: 40, b: 60 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                showlegend: false,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                xaxis: {
                    gridcolor: 'rgba(128,128,128,0.2)',
                    tickangle: -45
                },
                yaxis: {
                    gridcolor: 'rgba(128,128,128,0.2)',
                    title: 'Number of Incidents'
                }
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('timelineChart', [trace], layout, config);
        }

        function createTicketTypeChart() {
            const counts = {};
            filteredData.forEach(item => {
                const ticketType = item.type || 'Unknown';
                counts[ticketType] = (counts[ticketType] || 0) + 1;
            });

            const sortedEntries = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 8);

            const trace = {
                labels: sortedEntries.map(([ticketType, count]) => ticketType),
                values: sortedEntries.map(([ticketType, count]) => count),
                type: 'pie',
                hole: 0.6,
                marker: {
                    colors: colorSchemes.sources,
                    line: { color: 'white', width: 2 }
                },
                textinfo: 'label+percent',
                textfont: { size: 11 },
                hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
            };

            const layout = {
                margin: { l: 20, r: 20, t: 40, b: 40 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                showlegend: true,
                legend: { orientation: 'h', y: -0.1 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('ticketTypeChart', [trace], layout, config);
        }

        function createHeatmapChart() {
            const statusMap = { 0: 'Pending', 1: 'Active', 2: 'Closed', 3: 'Archive' };
            const impacts = [...new Set(filteredData.map(item => item.impact))].filter(i => i && i !== 'Unknown').sort();
            const statuses = [...new Set(filteredData.map(item => statusMap[item.status]))].filter(s => s).sort();

            const matrix = [];
            const hoverText = [];

            statuses.forEach(status => {
                const row = [];
                const hoverRow = [];
                impacts.forEach(impact => {
                    const count = filteredData.filter(item =>
                        item.impact === impact && statusMap[item.status] === status
                    ).length;
                    row.push(count);
                    hoverRow.push(`Impact: ${impact}<br>Status: ${status}<br>Count: ${count}`);
                });
                matrix.push(row);
                hoverText.push(hoverRow);
            });

            const trace = {
                z: matrix,
                x: impacts,
                y: statuses,
                type: 'heatmap',
                colorscale: 'Viridis',
                hovertemplate: '%{text}<extra></extra>',
                text: hoverText,
                showscale: true
            };

            const layout = {
                margin: { l: 80, r: 40, t: 40, b: 80 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { tickangle: -45 },
                yaxis: { autorange: 'reversed' }
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('heatmapChart', [trace], layout, config);
        }

        function createFunnelChart() {
            const statusMap = { 0: 'Pending', 1: 'Active', 2: 'Closed', 3: 'Archive' };
            const escalationCounts = {};

            filteredData.forEach(item => {
                const escalation = item.escalation_state || 'Unknown';
                escalationCounts[escalation] = (escalationCounts[escalation] || 0) + 1;
            });

            const sortedEntries = Object.entries(escalationCounts).sort((a, b) => b[1] - a[1]);

            const trace = {
                type: 'funnel',
                y: sortedEntries.map(([escalation, count]) => escalation),
                x: sortedEntries.map(([escalation, count]) => count),
                textinfo: 'value+percent initial',
                marker: {
                    color: colorSchemes.status,
                    line: { color: 'white', width: 2 }
                },
                hovertemplate: '<b>%{y}</b><br>Count: %{x}<br>Percentage: %{percentInitial}<extra></extra>'
            };

            const layout = {
                margin: { l: 120, r: 20, t: 40, b: 40 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)'
            };

            const config = { responsive: true, displayModeBar: true, displaylogo: false };
            Plotly.newPlot('funnelChart', [trace], layout, config);
        }

        function updateTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            const displayData = filteredData.slice(0, 100); // Limit to 100 rows for performance

            displayData.forEach(item => {
                const row = document.createElement('tr');

                const severityMap = { 0: 'Unknown', 1: 'Low', 2: 'Medium', 3: 'High', 4: 'Critical' };
                const statusMap = { 0: 'Pending', 1: 'Active', 2: 'Closed' };

                const severity = severityMap[item.severity] || 'Unknown';
                const status = statusMap[item.status] || 'Unknown';

                row.innerHTML = `
                    <td><a href="https://msoar.crtx.us.paloaltonetworks.com/Custom/caseinfoid/${item.id}" target="_blank" style="color: #0046ad; text-decoration: underline;">${item.id}</a></td>
                    <td title="${item.name}">${item.name.substring(0, 50)}${item.name.length > 50 ? '...' : ''}</td>
                    <td><span class="severity-${severity.toLowerCase()}">${severity}</span></td>
                    <td><span class="status-${status.toLowerCase()}">${status}</span></td>
                    <td>${item.affected_country}</td>
                    <td>${item.impact}</td>
                    <td>${item.type}</td>
                    <td>${new Date(item.created).toLocaleDateString()}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function exportToCSV() {
            const headers = ['ID', 'Name', 'Severity', 'Status', 'Country', 'Impact', 'Type', 'Created'];
            const severityMap = { 0: 'Unknown', 1: 'Low', 2: 'Medium', 3: 'High', 4: 'Critical' };
            const statusMap = { 0: 'Pending', 1: 'Active', 2: 'Closed' };

            const csvContent = [
                headers.join(','),
                ...filteredData.map(item => [
                    item.id,
                    `"${item.name.replace(/"/g, '""')}"`,
                    severityMap[item.severity] || 'Unknown',
                    statusMap[item.status] || 'Unknown',
                    item.affected_country,
                    item.impact,
                    item.type,
                    new Date(item.created).toISOString()
                ].join(','))
            ].join('\n');

            downloadCSV(csvContent, 'security_incidents.csv');
        }

        function exportSummary() {
            const totalIncidents = filteredData.length;
            const criticalIncidents = filteredData.filter(item => item.severity === 4).length;
            const openIncidents = filteredData.filter(item => item.status !== 2).length;

            const summaryData = [
                ['Metric', 'Value'],
                ['Total Incidents', totalIncidents],
                ['Critical Incidents', criticalIncidents],
                ['Open Incidents', openIncidents],
                ['Countries Affected', new Set(filteredData.map(item => item.affected_country)).size],
                ['Top Country', getMostCommon('affected_country')],
                ['Top Ticket Type', getMostCommon('type')]
            ];

            const csvContent = summaryData.map(row => row.join(',')).join('\n');
            downloadCSV(csvContent, 'incident_summary.csv');
        }

        function getMostCommon(field) {
            const counts = {};
            filteredData.forEach(item => {
                const value = item[field] || 'Unknown';
                counts[value] = (counts[value] || 0) + 1;
            });

            return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, 'N/A');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function showDashboard() {
            document.getElementById('metricsGrid').style.display = 'grid';
            document.getElementById('chartsGrid').style.display = 'grid';
            document.getElementById('dataTableSection').style.display = 'block';
        }

        // Navigation functions
        function toggleMenu() {
            const menu = document.getElementById('burgerMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function toggleAudio() {
            // Placeholder for audio functionality
            const icon = document.getElementById('music-icon');
            icon.style.opacity = icon.style.opacity === '0.5' ? '1' : '0.5';
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('burgerMenu');
            const burger = document.querySelector('.nav-burger');
            if (!burger.contains(event.target) && !menu.contains(event.target)) {
                menu.style.display = 'none';
            }
        });
    </script>
    <script src="/static/js/common.js"></script>
    <script>
        initRandomMusic();

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');

            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.textContent = 'üåô';
                themeToggle.title = 'Toggle Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const themeToggle = document.querySelector('.theme-toggle');

            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
                themeToggle.title = 'Toggle Light Mode';
            }
        });

        function toggleMenu() {
            var menu = document.getElementById('burgerMenu');
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
        }

        // Close menu when a link is clicked
        document.addEventListener('DOMContentLoaded', function () {
            var burgerMenu = document.getElementById('burgerMenu');
            if (burgerMenu) {
                burgerMenu.querySelectorAll('a').forEach(function (link) {
                    link.addEventListener('click', function () {
                        burgerMenu.style.display = 'none';
                    });
                });
            }
        });

        // Close burger menu when clicking outside
        document.addEventListener('click', function (e) {
            var burgerMenu = document.getElementById('burgerMenu');
            var navBurger = document.querySelector('.nav-burger');

            if (burgerMenu && !burgerMenu.contains(e.target) && !navBurger.contains(e.target)) {
                burgerMenu.style.display = 'none';
            }
        });
    </script>
</body>
</html>