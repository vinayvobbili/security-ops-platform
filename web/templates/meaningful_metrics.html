<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METCIRT MetricsğŸ“ˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/meaningful_metrics.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='icons/metrics-dashboard-icon.ico') }}" type="image/x-icon">

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
</head>
<body>
<!-- Top Navigation Bar -->
{% include 'burger_menu.html' %}

<audio id="music" src="" loop muted></audio>
<div class="audio-controls">
    <button id="audioToggleBtn">
        <img src="/static/icons/volume-xmark-solid.svg" alt="Unmute Icon" class="music-icon" id="music-icon">
    </button>
</div>
<!-- Dark Mode Toggle -->
<div class="theme-toggle" id="themeToggleWrapper">
    <button id="themeToggleBtn" aria-label="Toggle dark mode" title="Toggle dark mode">ğŸŒ™</button>
</div>

<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <span class="title-icon left">ğŸ“Š</span>
            Amazing Actionable Analytics
            <span class="title-icon right">ğŸ’°</span>
        </h1>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-header">
            <div class="header-left">
                ğŸ›ï¸ Filter Controls
            </div>
            <div class="header-right">
                <div class="slider-field">
                    <label class="date-range-label">ğŸ“…<br>Created in past (days):</label>
                    <div class="date-range-slider-container" style="position: relative;">
                        <div id="dateRangeTooltip" class="slider-tooltip" style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 10; display: none;">30</div>
                        <label for="dateRangeSlider"></label><input type="range" id="dateRangeSlider" class="date-range-slider" min="1" max="90" value="30" step="1">
                        <div class="slider-labels">
                            <span class="range-preset" data-value="1" style="cursor: pointer;">1</span>
                            <span class="range-preset" data-value="30" style="cursor: pointer;">30</span>
                            <span class="range-preset" data-value="90" style="cursor: pointer;">90</span>
                        </div>
                    </div>
                </div>
                <div class="slider-field">
                    <label class="date-range-label">â±ï¸<br>TTR<br>(mins):</label>
                    <div class="date-range-slider-container" style="position: relative;">
                        <div id="mttrRangeTooltip" class="slider-tooltip" style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 10; display: none;">All</div>
                        <label for="mttrRangeSlider"></label><input type="range" id="mttrRangeSlider" class="date-range-slider" min="0" max="3" value="0" step="1">
                        <div class="slider-labels">
                            <span data-value="0" class="active">All</span>
                            <span data-value="1">â‰¤3</span>
                            <span data-value="2">>3</span>
                            <span data-value="3">>5</span>
                        </div>
                    </div>
                </div>
                <div class="slider-field">
                    <label class="date-range-label">ğŸ”’<br>TTC<br>(mins):</label>
                    <div class="date-range-slider-container" style="position: relative;">
                        <div id="mttcRangeTooltip" class="slider-tooltip" style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 10; display: none;">All</div>
                        <label for="mttcRangeSlider"></label><input type="range" id="mttcRangeSlider" class="date-range-slider" min="0" max="3" value="0" step="1">
                        <div class="slider-labels">
                            <span data-value="0" class="active">All</span>
                            <span data-value="1">â‰¤5</span>
                            <span data-value="2">â‰¤15</span>
                            <span data-value="3">>15</span>
                        </div>
                    </div>
                </div>
                <div class="slider-field">
                    <label class="date-range-label">ğŸ“†<br>Age<br>(days): <span title="Age filter applies only to currently open tickets (closed tickets stop aging)" style="cursor: help;">â„¹ï¸</span></label>
                    <div class="date-range-slider-container" style="position: relative;">
                        <div id="ageRangeTooltip" class="slider-tooltip" style="position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; pointer-events: none; z-index: 10; display: none;">All</div>
                        <label for="ageRangeSlider"></label><input type="range" id="ageRangeSlider" class="date-range-slider" min="0" max="60" value="0" step="1">
                        <div class="slider-labels">
                            <span class="range-preset" data-value="0" style="cursor: pointer;">All</span>
                            <span class="range-preset" data-value="7" style="cursor: pointer;">>7</span>
                            <span class="range-preset" data-value="30" style="cursor: pointer;">>30</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="filters-grid">
            <div class="filter-group">
                <div class="location-filter-tabs">
                    <div class="tab-buttons">
                        <button class="tab-button" data-tab="country">ğŸ‡ºğŸ‡¸ Country</button>
                        <button class="tab-button active" data-tab="region">ğŸŒ Region</button>
                    </div>
                    <div class="tab-content">
                        <div id="countryTab" class="tab-pane">
                            <div id="countryFilter" class="checkbox-filter">
                            </div>
                        </div>
                        <div id="regionTab" class="tab-pane active">
                            <div id="regionFilter" class="checkbox-filter">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸ’¥ Impact Level</label>
                <div id="impactFilter" class="checkbox-filter">
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸš¨ Severity</label>
                <div id="severityFilter" class="checkbox-filter">
                    <label><input type="checkbox" value="4"> Critical</label>
                    <label><input type="checkbox" value="3"> High</label>
                    <label><input type="checkbox" value="2"> Medium</label>
                    <label><input type="checkbox" value="1"> Low</label>
                </div>
            </div>
            <div class="filter-group ticket-type-filter">
                <label class="filter-label">ğŸ« Ticket Type</label>
                <div id="ticketTypeFilter" class="checkbox-filter">
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸ“Š Status</label>
                <div id="statusFilter" class="checkbox-filter">
                    <label><input type="checkbox" value="0"> Pending</label>
                    <label><input type="checkbox" value="1"> Active</label>
                    <label><input type="checkbox" value="2"> Closed</label>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">ğŸ¤– Automation Level</label>
                <div id="automationFilter" class="checkbox-filter">
                    <label><input type="checkbox" value="Manual"> Manual</label>
                    <label><input type="checkbox" value="Semi-Automated"> Semi-Auto</label>
                    <label><input type="checkbox" value="Automated"> Automated</label>
                    <label><input type="checkbox" value="Unknown"> Unknown</label>
                </div>
            </div>
        </div>

        <!-- Filter Summary -->
        <div class="filter-summary" id="filterSummary">
            <div class="filter-summary-content">
                <strong>Active Filters:</strong>
                <span class="active-filters-container" id="activeFiltersContainer">
                    <span class="filter-tag non-removable" title="Unique: Excludes duplicate tickets received for the same host within the past hour">Unique â„¹ï¸</span>
                    <span class="filter-tag">Last 30 days</span>
                </span>
            </div>
            <button class="clear-all-btn" id="resetFiltersBtn">Reset</button>
        </div>
    </div>

    <!-- Loading/Error Display -->
    <div id="loading" class="loading">
        ğŸ”„ Loading security alerts data...
    </div>
    <div id="error" class="error" style="display: none;"></div>

    <!-- Metrics Cards -->
    <div id="metricsGrid" class="metrics-grid" style="display: none;">
        <!-- Metrics will be populated by JavaScript -->
    </div>

    <!-- Charts Grid -->
    <div id="chartsGrid" class="charts-grid" style="display: none;">
        <div class="chart-container">
            <div class="chart-title">ğŸŒ Geographic Distribution (Top 10)</div>
            <div id="geoChart" class="chart-canvas"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ« Ticket Type Distribution</div>
            <div id="severityChart" class="chart-canvas"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ“ˆ Daily Alerts Timeline</div>
            <div id="timelineChart" class="chart-canvas"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ’¥ Impact Distribution</div>
            <div id="ticketTypeChart" class="chart-canvas"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ‘¤ Owner Distribution</div>
            <div id="heatmapChart" class="chart-canvas"></div>
        </div>
        <div class="chart-container">
            <div class="chart-title">ğŸ” Case Analysis Funnel</div>
            <div id="funnelChart" class="chart-canvas"></div>
        </div>
    </div>

    <!-- Data Table -->
    <div id="dataTableSection" class="data-table-section" style="display: none;">
        <div class="table-controls">
            <div class="table-header">ğŸ“‹ Case Details (showing first 100 results)</div>
            <div class="column-selector">
                <button id="columnSelectorBtn" class="column-selector-btn">âš™ï¸ Columns</button>
                <div id="columnSelectorDropdown" class="column-selector-dropdown" style="display: none;">
                    <div class="column-selector-content">
                        <div class="column-selector-header">
                            <span>Select Columns to Display</span>
                            <div class="column-selector-buttons">
                                <button id="selectAllColumnsBtn" class="select-all-btn">Select All</button>
                                <button id="deselectAllColumnsBtn" class="deselect-all-btn">Deselect All</button>
                            </div>
                        </div>
                        <div id="columnCheckboxes" class="column-checkboxes">
                            <!-- Checkboxes will be populated by JavaScript -->
                        </div>
                        <div class="column-order-section">
                            <div class="column-order-header">
                                <strong>Column Order</strong>
                                <span class="order-help">(Drag to reorder)</span>
                            </div>
                            <div id="columnOrderList" class="column-order-list">
                                <!-- Order list will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table id="dataTable" class="data-table">
                <thead>
                <tr>
                    <th class="sortable" data-column="id">ID <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="name">Name <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="severity">Severity <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="status">Status <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="affected_country">Country <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="impact">Impact <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="type">Source <span class="sort-indicator"></span></th>
                    <th class="sortable" data-column="created">Created <span class="sort-indicator"></span></th>
                </tr>
                </thead>
                <tbody>
                <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
        <div class="export-section">
            <button class="export-btn" id="exportCsvBtn">ğŸ“¥ Export to CSV</button>
            <button class="export-btn" id="exportSummaryBtn">ğŸ“Š Export Summary</button>
        </div>
    </div>

    <!-- Data freshness info -->
    <div class="data-freshness">
        <span class="freshness-label">Data generated:</span>
        <span id="dataTimestamp" class="freshness-timestamp">Loading...</span>
        <span class="freshness-note">(Updated daily at 12:01 AM ET)</span>
    </div>
</div>

<!-- Toast / Live region for accessibility -->
<div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script src="/static/js/common.js"></script>
<script src="{{ url_for('static', filename='js/meaningful_metrics.js') }}"></script>
<script>
    initRandomMusic();
    initBurgerMenu();
    if (typeof initTheme === 'function') {
        initTheme();
    }
</script>
</body>
</html>
